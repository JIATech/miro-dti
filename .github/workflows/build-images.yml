name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
    # También puedes agregar más branches si usas otro nombre como master, develop, etc.

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      # Verificar y corregir el directorio mirotalksfu
      - name: Check mirotalksfu directory
        run: |
          echo "Verificando directorio mirotalksfu..."
          if [ ! -d "mirotalksfu" ]; then
            echo "El directorio mirotalksfu no existe, clonando desde el repositorio..."
            git clone https://github.com/miroslavpejic85/mirotalksfu.git mirotalksfu
          fi
          
          echo "Verificando Dockerfile en mirotalksfu..."
          if [ ! -f "mirotalksfu/Dockerfile" ]; then
            echo "ERROR: No se encontró Dockerfile en mirotalksfu"
            exit 1
          fi
          
          echo "Contenido del directorio mirotalksfu:"
          ls -la mirotalksfu/
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      # Construir y publicar PWA
      - name: Build and push PWA image
        uses: docker/build-push-action@v4
        with:
          context: ./pwa
          push: true
          tags: dtiteam/intercom-pwa:latest
      
      # Construir y publicar Signaling
      - name: Build and push Signaling image
        uses: docker/build-push-action@v4
        with:
          context: ./signaling
          push: true
          tags: dtiteam/intercom-signaling:latest
      
      # Construir y publicar Admin
      - name: Build and push Admin image
        uses: docker/build-push-action@v4
        with:
          context: ./admin
          push: true
          tags: dtiteam/intercom-admin:latest
      
      # Preparar Dockerfile temporal para MiroTalkSFU
      - name: Prepare MiroTalkSFU Dockerfile
        run: |
          cd mirotalksfu
          echo "Creando Dockerfile.github con modificaciones..."
          
          # Verificar patrones a reemplazar
          if grep -q "groupadd -r mirotalk -g 1000" Dockerfile; then
            echo "Modificando patrón de creación de grupo..."
            sed 's/groupadd -r mirotalk -g 1000/getent group mirotalk || groupadd -r mirotalk || groupadd -r mirotalk/' Dockerfile > Dockerfile.github
          else
            echo "Patrón de grupo no encontrado, copiando archivo original..."
            cp Dockerfile Dockerfile.github
          fi
          
          if grep -q "useradd -u 1000 -r -g mirotalk" Dockerfile.github; then
            echo "Modificando patrón de creación de usuario..."
            sed -i 's/useradd -u 1000 -r -g mirotalk/getent passwd mirotalk || useradd -r -g mirotalk || useradd -r -g mirotalk/' Dockerfile.github
          fi
          
          echo "Contenido del Dockerfile.github:"
          cat Dockerfile.github
      
      # Construir y publicar MiroTalkSFU con el Dockerfile modificado
      - name: Build and push MiroTalkSFU image
        uses: docker/build-push-action@v4
        with:
          context: ./mirotalksfu
          file: ./mirotalksfu/Dockerfile.github
          push: true
          tags: dtiteam/intercom-mirotalksfu:latest
          build-args: |
            NODE_ENV=production
            MEDIASOUP_SKIP_WORKER_PREBUILT_DOWNLOAD=true
          no-cache: true
